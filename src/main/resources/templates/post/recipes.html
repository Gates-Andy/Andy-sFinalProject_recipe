<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layouts/default}">

<main layout:fragment="contents" class="recipes">

	<div id="wrap" class="main-body">

		<div class="recipesthym">

			<section class="recipes-info-left">

				<article class="myrecipe">

					<img class="menu-pic" th:src="${postDto.imagePath}" alt="ì™„ì„± ìŒì‹">

					<h2 class="menu-title" th:text="${postDto.title}"></h2>

					<p class="description" th:text="${postDto.content}"></p>

					<div class="steps">
						<h3>ğŸ½ ìš”ë¦¬ ìˆœì„œ</h3>
						<div th:each="step : ${postDto.stepList}" class="step-box" style="margin-bottom: 32px;">
							<h4 th:text="'STEP ' + ${step.stepNumber}"></h4>
							<img th:src="${step.imagePath}" alt="ë‹¨ê³„ ì´ë¯¸ì§€" style="width: 100%; max-width: 500px; height: auto; border-radius: 8px; margin-bottom: 16px;" />
							<p th:text="${step.content}" style="font-size: 18px;"></p>
						</div>
					</div>

				</article>

			</section>

			<div class="recipes-info-right">

				<div class="ingredients-list">
					<h4>ğŸ³ ì¬ë£Œ ëª©ë¡</h4>
					<div th:each="ingredient : ${postDto.ingredientList}" class="ingredient-box">
						<img th:src="${ingredient.imagePath}" alt="ì¬ë£Œ ì´ë¯¸ì§€">
						<div>
							<span th:text="${ingredient.ingredientName}">ì¬ë£Œëª…</span> 
							
														- 
														
							<span th:text="${ingredient.ingredientAmount}">ìˆ˜ëŸ‰</span>
						</div>
					</div>
				</div>

			</div>
		</div>

	</div>

	<div class="icons d-flex justify-content-start align-items-center">

		<i th:unless="${postDto.likedByCurrentUser}" class="bi bi-heart text-danger heartIcon" th:data-post-id="${postDto.id}"></i> 
		<i th:if="${postDto.likedByCurrentUser}" class="bi bi-heart-fill text-danger heartIcon" th:data-post-id="${postDto.id}"></i> 
		<span th:text="${postDto.likeCount}"></span> 
		<input type="text" class="form-control col-10 comment-text" id="text" placeholder="ëŒ“ê¸€ì„ ë“±ë¡ í•´ì£¼ì„¸ìš”">

		<button type="button" class="form-control comment-submit" th:data-post-id="${postDto.id}" >ë“±ë¡</button>

	</div>

	<div class="comments">
	    <div th:each="comment : ${postDto.commentList}" 
	         class="d-flex justify-content-between align-items-center">
	        
	        <div>
	            <span th:text="${comment.userName}"></span> : 
	            <span th:text="${comment.text}">ëŒ“ê¸€ ë‚´ìš©</span>
	        </div>
	        
	        <a href="#" class="comment-delete text-danger" th:data-comment-id="${comment.id}" th:if="${comment.userId == session.userId}">
	           ëŒ“ê¸€ ì‚­ì œ
	        </a>
	    </div>
	</div>

</main>

<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

<script layout:fragment="script">
	$(".comment-delete").on("click", function(e) {
	    e.preventDefault();
	
	    if (!confirm("ì •ë§ ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
	
	    let commentId = $(this).data("comment-id");
	
	    $.ajax({
	        type: "post",
	        url: "/post/comment/delete",
	        data: { 
	        	commentId : commentId 
	        },
	        success: function(response) {
	            if (response.result === "success") {
	                location.reload();
	            } else {
	                alert("ëŒ“ê¸€ ì‚­ì œ ì‹¤íŒ¨");
	            }
	        },
	        error: function() {
	            alert("ëŒ“ê¸€ ì‚­ì œ ì—ëŸ¬!");
	        }
	    });
	});
	
	$(".comment-submit").on("click", function() {
		
		let postId = $(this).data("post-id");
    	let text = $("#text").val().trim();
		
    	if(text === ""){
    		alert("ëŒ“ê¸€ì„ ì‘ì„± í•´ì£¼ì„¸ìš”");
    		return;
    	}
    	
		$.ajax({
			type : "post",
			url : "/post/comment/create",
			data : {
				postId : postId,
				text : text
			},
			success : function(response) {
				if (response.result === "success") {
					location.reload();
				} else {
					alert("ëŒ“ê¸€ ì‹¤íŒ¨");
				}
			},
			error : function() {
				alert("ëŒ“ê¸€ ì—ëŸ¬!");
			}
		});
	});

	$(".heartIcon").on("click", function() {

		let postId = $(this).data("post-id");

		if ($(this).hasClass("bi-heart-fill")) {
			$.ajax({
				type : "post",
				url : "/post/dislike",
				data : {
					postId : postId
				},
				success : function(response) {
					if (response.result === "success") {
						location.reload();
					} else {
						alert("ì¢‹ì•„ìš” ì·¨ì†Œ ì‹¤íŒ¨!");
					}
				},
				error : function() {
					alert("ì¢‹ì•„ìš” ì·¨ì†Œ ì—ëŸ¬!");
				}
			});
		}

		else {
			$.ajax({
				type : "post",
				url : "/post/like",
				data : {
					postId : postId
				},
				success : function(response) {
					if (response.result === "success") {
						location.reload();
					} else {
						alert("ì¢‹ì•„ìš” ì‹¤íŒ¨!");
					}
				},
				error : function() {
					alert("ì¢‹ì•„ìš” ì—ëŸ¬!");
				}
			});
		}
	});
</script>
</html>