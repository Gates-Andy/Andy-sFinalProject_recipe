<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layouts/default}">

<main layout:fragment="contents">

	<div class="edit" th:each="postDto : ${PostDto}">
	
		<input type="hidden" id="postId" th:value="${postDto.id}">
		
		<div class="type-box d-flex justify-content-between align-items-center">
			<input type="text" id="titleInput" th:value="${postDto.title}">
			<input type="number" id="headcountInput" th:value="${postDto.headcount}">
			<input type="text" id="categoryInput" th:value="${postDto.category}">
		</div>

		<div class="content">
			<textarea class="form-control" id="contentInput" placeholder="요리 설명을 해보아요" th:text="${postDto.content}"></textarea>
		</div>

		<div class="upload-section ">
			<label class="btn-imginput btn btn-secondary"> 
				<input type="file" id="fileInput" hidden>사진 첨부
			</label> 
			<span id="fileName">image.png</span>
		</div>

		<div class="function d-flex justify-content-between">
			<button type="button" class="btn-delete btn btn-danger" id="deletebtn">레시피 삭제</button>
			<button type="button" class="btn-save btn btn-primary" id="savebtn">MyRecipe에 저장</button>
		</div>
		
	</div>

</main>

<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

<script layout:fragment="script">

$("#deletebtn").on("click", function() {

	let id = $("#postId").val();

	$.ajax({
		type : "delete",
		url : "/post/delete",
		data : { "id" : id
		},
		success : function(response) {
			if (response.result === "success") {
				alert("삭제성공!");
				location.href = "/post/main/view";
			} else {
				alert("삭제 실패");
			}
		},
		error : function() {
			alert("삭제 에러!");
		}
	});
});

$("#savebtn").on("click", function () {
	let postId = $("#postId").val();
	let title = $("#titleInput").val();
	let headcount = $("#headcountInput").val();
	let category = $("#categoryInput").val();
	let content = $("#contentInput").val();
	let file = $("#fileInput")[0].files[0];
	
	if (title === "") {
		alert("레시피 이름을 입력해주세요.");
		return;
	}

	if (category === "") {
		alert("카테고리를 입력해주세요.");
		return;
	}

	if (!headcount || isNaN(headcount)) {
		alert("인원수를 올바르게 입력해주세요.");
		return;
	}

	if (content === "") {
		alert("요리 설명을 입력해주세요.");
		return;
	}

	let formData = new FormData();
	formData.append("postId", postId);
	
	formData.append("title", title);
	formData.append("headcount", headcount);
	formData.append("category", category);
	formData.append("content", content);
	
	if (file) {
		formData.append("imageFile", file);
	}

	$.ajax({
		type: "put",
		url: "/post/update",
		data: formData,
		enctype: "multipart/form-data",
		processData: false,
		contentType: false,
		success: function (response) {
			if (response.result === "success") {
				location.href = "/post/main/view";
			} else {
				alert("레시피 저장 실패.");
			}
		},
		error: function () {
			alert("레시피 저장 에러");
		}
	});
});

</script>
</body>
</html>